{% extends "base.html" %}

{% block title %}{{ video.title }} - WeTube{% endblock %}

{% block content %}
  <!-- ë¡œê·¸ì¸ ë¯¸ì—°ë™: ì‹œì²­ì€ ë¡œê·¸ì¸ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥ (ì—…ë¡œë“œì™€ ë™ì¼) -->
  <div class="watch-page">
    <div class="watch-content">
      <!-- ë©”ì¸ ë¹„ë””ì˜¤ ì˜ì—­ -->
      <div class="watch-main">
        <!-- ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ (HTML5 video, video.get_video_url(), poster) -->
        <div class="video-player">
          <video controls class="video-player-el" poster="{{ video.get_thumbnail_url() or '' }}">
            <source src="{{ video.get_video_url() }}" type="video/mp4">
            ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
          </video>
        </div>

        <!-- ë¹„ë””ì˜¤ ì •ë³´ -->
        <div class="video-info">
          <h1 class="video-title">{{ video.title }}</h1>
          <div class="video-stats">
            <span class="video-views">ì¡°íšŒìˆ˜ {{ video.views }}íšŒ</span>
            <span class="video-date">{{ video.created_at.strftime('%Y. %m. %d.') if video.created_at else '' }}</span>
          </div>

          <!-- ì•¡ì…˜ ë²„íŠ¼ -->
          <div class="video-actions">
            <div class="video-actions-left">
              <button type="button" class="action-btn action-btn--like" id="btn-like" title="ì¢‹ì•„ìš”" data-video-id="{{ video.id }}" data-initial-likes="{{ video.likes }}">
                <span class="action-btn-inner">
                  <span class="action-icon action-icon--heart" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                  </span>
                  <span class="action-label">ì¢‹ì•„ìš”</span>
                  <span class="action-count">{{ video.likes }}</span>
                </span>
              </button>
            </div>
            <div class="video-actions-right">
              <button type="button" class="action-btn" id="btn-more" title="ë”ë³´ê¸°">
                <span class="action-icon">â‹¯</span>
              </button>
            </div>
          </div>
        </div>

        <!-- ì±„ë„ ì •ë³´ -->
        <div class="channel-info">
          <a href="{{ url_for('main.user_profile', username=channel_name) }}" class="channel-avatar">
            <span>{{ (channel_name or 'D')[0]|upper }}</span>
          </a>
          <div class="channel-details">
            <a href="{{ url_for('main.user_profile', username=channel_name) }}" class="channel-name">{{ channel_name }}</a>
            <div class="channel-subs" id="channel-subs">êµ¬ë…ì {{ subscriber_count }}ëª…</div>
          </div>
          <button type="button" class="btn {% if is_subscribed %}btn--outline subscribed{% else %}btn--primary{% endif %}" id="btn-subscribe" data-channel-username="{{ channel_name }}">{{ 'êµ¬ë…ì¤‘' if is_subscribed else 'êµ¬ë…' }}</button>
        </div>

        <!-- íƒœê·¸ (DB ì—°ë™) -->
        {% if video.tags %}
        <div class="video-tags">
          {% for t in video.tags %}
          <a href="{{ url_for('main.tag', tag_name=t.name) }}" class="tag-pill tag-pill--small">#{{ t.name }}</a>
          {% endfor %}
        </div>
        {% endif %}

        <!-- ì„¤ëª… -->
        <div class="video-description">
          <div class="description-content" id="description-content">
            {% if video.description %}
            <p>{{ video.description }}</p>
            {% else %}
            <p>ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
          </div>
          <button type="button" class="description-toggle" id="description-toggle">ë”ë³´ê¸°</button>
        </div>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <div class="comments-section">
          <div class="comments-header">
            <h2 class="comments-title">ëŒ“ê¸€ <span id="comments-count">{{ total_comments|default(0) }}</span>ê°œ</h2>
            <div class="comments-sort">
              <button type="button" class="sort-btn active">ìµœì‹ ìˆœ</button>
            </div>
          </div>

          <!-- ëŒ“ê¸€ ì‘ì„± (ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ) -->
          {% if current_user.is_authenticated %}
          <div class="comment-form">
            <div class="comment-avatar">
              {% if current_user.profile_image %}
              <img src="{{ url_for('main.media_profile', filename=current_user.profile_image) }}" alt="" class="comment-avatar-img">
              {% else %}
              <span>{{ (current_user.username or 'U')[0]|upper }}</span>
              {% endif %}
            </div>
            <form class="comment-input-wrap" method="post" action="{{ url_for('comments.create') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="video_id" value="{{ video.id }}">
              <input type="text" name="content" id="comment-input" class="comment-input" placeholder="ëŒ“ê¸€ ì¶”ê°€..." required maxlength="2000">
              <div class="comment-actions" id="comment-actions" style="display: none;">
                <button type="button" class="btn btn--outline" id="comment-cancel">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn--primary">ëŒ“ê¸€</button>
              </div>
            </form>
          </div>
          {% else %}
          <p class="comment-login-prompt"><a href="{{ url_for('auth.login') }}">ë¡œê·¸ì¸</a>í•´ì„œ ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>
          {% endif %}

          <!-- ëŒ“ê¸€ ëª©ë¡ -->
          <div class="comments-list" id="comments-list">
            {% for c in comments or [] %}
            <div class="comment-item" data-comment-id="{{ c.id }}">
              <div class="comment-avatar">
                {% if c.user and c.user.profile_image %}
                <img src="{{ url_for('main.media_profile', filename=c.user.profile_image) }}" alt="" class="comment-avatar-img">
                {% else %}
                <span>{{ (c.user.username if c.user else 'U')[0]|upper }}</span>
                {% endif %}
              </div>
              <div class="comment-body">
                <div class="comment-header">
                  <span class="comment-author">{{ c.user.username if c.user else 'ì•Œ ìˆ˜ ì—†ìŒ' }}</span>
                  <span class="comment-time">{{ c.created_at|timesince }}</span>
                </div>
                <div class="comment-content-wrap">
                  <p class="comment-text" data-comment-id="{{ c.id }}">{{ c.content }}</p>
                  {% if current_user.is_authenticated and current_user.id == c.user_id %}
                  <div class="comment-edit-form" id="edit-form-{{ c.id }}" style="display: none;">
                    <form method="post" action="{{ url_for('comments.edit', comment_id=c.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <input type="text" name="content" value="{{ c.content }}" class="comment-edit-input">
                      <button type="submit" class="btn btn--primary btn--small">ì €ì¥</button>
                      <button type="button" class="btn btn--outline btn--small comment-edit-cancel" data-comment-id="{{ c.id }}">ì·¨ì†Œ</button>
                    </form>
                  </div>
                  {% endif %}
                </div>
                <div class="comment-footer">
                  <button type="button" class="comment-action">ğŸ‘ {{ c.likes }}</button>
                  <button type="button" class="comment-action">ğŸ‘</button>
                  {% if current_user.is_authenticated %}
                  <button type="button" class="comment-action comment-reply-btn" data-parent-id="{{ c.id }}">ë‹µê¸€</button>
                  {% endif %}
                  {% if current_user.is_authenticated and current_user.id == c.user_id %}
                  <button type="button" class="comment-action comment-edit-btn" data-comment-id="{{ c.id }}">ìˆ˜ì •</button>
                  <form method="post" action="{{ url_for('comments.delete', comment_id=c.id) }}" class="comment-delete-form" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="comment-action comment-delete-btn" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?');">ì‚­ì œ</button>
                  </form>
                  {% endif %}
                </div>
                <!-- ëŒ€ëŒ“ê¸€ ì˜ì—­ -->
                <div class="comment-replies" id="replies-{{ c.id }}">
                  {% for r in c.replies %}
                  <div class="comment-item comment-item--reply" data-comment-id="{{ r.id }}">
                    <div class="comment-avatar">
                      {% if r.user and r.user.profile_image %}
                      <img src="{{ url_for('main.media_profile', filename=r.user.profile_image) }}" alt="" class="comment-avatar-img">
                      {% else %}
                      <span>{{ (r.user.username if r.user else 'U')[0]|upper }}</span>
                      {% endif %}
                    </div>
                    <div class="comment-body">
                      <div class="comment-header">
                        <span class="comment-author">{{ r.user.username if r.user else 'ì•Œ ìˆ˜ ì—†ìŒ' }}</span>
                        <span class="comment-time">{{ r.created_at|timesince }}</span>
                      </div>
                      <div class="comment-content-wrap">
                        <p class="comment-text" data-comment-id="{{ r.id }}">{{ r.content }}</p>
                        {% if current_user.is_authenticated and current_user.id == r.user_id %}
                        <div class="comment-edit-form" id="edit-form-{{ r.id }}" style="display: none;">
                          <form method="post" action="{{ url_for('comments.edit', comment_id=r.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="text" name="content" value="{{ r.content }}" class="comment-edit-input">
                            <button type="submit" class="btn btn--primary btn--small">ì €ì¥</button>
                            <button type="button" class="btn btn--outline btn--small comment-edit-cancel" data-comment-id="{{ r.id }}">ì·¨ì†Œ</button>
                          </form>
                        </div>
                        {% endif %}
                      </div>
                      <div class="comment-footer">
                        <button type="button" class="comment-action">ğŸ‘ {{ r.likes }}</button>
                        <button type="button" class="comment-action">ğŸ‘</button>
                        {% if current_user.is_authenticated and current_user.id == r.user_id %}
                        <button type="button" class="comment-action comment-edit-btn" data-comment-id="{{ r.id }}">ìˆ˜ì •</button>
                        <form method="post" action="{{ url_for('comments.delete', comment_id=r.id) }}" class="comment-delete-form" style="display: inline;">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <button type="submit" class="comment-action comment-delete-btn" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?');">ì‚­ì œ</button>
                        </form>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                  <!-- ë‹µê¸€ ì‘ì„± í¼ (ë‹µê¸€ í´ë¦­ ì‹œ í‘œì‹œ) -->
                  {% if current_user.is_authenticated %}
                  <div class="reply-form-wrap" id="reply-form-wrap-{{ c.id }}" style="display: none;">
                    <form method="post" action="{{ url_for('comments.reply', comment_id=c.id) }}" class="reply-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <input type="text" name="content" placeholder="ë‹µê¸€ ì‘ì„±..." required maxlength="2000" class="comment-input">
                      <button type="submit" class="btn btn--primary btn--small">ë‹µê¸€</button>
                      <button type="button" class="btn btn--outline btn--small reply-cancel" data-parent-id="{{ c.id }}">ì·¨ì†Œ</button>
                    </form>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% else %}
            <p class="comments-empty">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- ì¶”ì²œ ë™ì˜ìƒ ì‚¬ì´ë“œë°” (DB ì—°ë™) -->
      <aside class="watch-sidebar">
        <h3 class="sidebar-title">ì¶”ì²œ ë™ì˜ìƒ</h3>
        <div class="related-videos">
          {% for v in related_videos or [] %}
          <a href="{{ url_for('main.watch', video_id=v.id) }}" class="related-video-card">
            <div class="related-video-thumb">
              {% if v.thumbnail_path %}
              <img src="{{ url_for('main.media_thumbnail', filename=v.thumbnail_path) }}" alt="" class="related-video-thumb-img">
              {% else %}
              <span>ğŸ“¹</span>
              {% endif %}
            </div>
            <div class="related-video-info">
              <h4 class="related-video-title">{{ v.title }}</h4>
              <a href="{{ url_for('main.user_profile', username=v.user.username if v.user else 'default') }}" class="related-video-channel" onclick="event.stopPropagation();">{{ v.user.username if v.user else 'default' }}</a>
              <p class="related-video-meta">ì¡°íšŒìˆ˜ {{ v.views }}íšŒ Â· ì¢‹ì•„ìš” {{ v.likes|default(0) }}</p>
            </div>
          </a>
          {% else %}
          <p class="related-empty">ì¶”ì²œ ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
          {% endfor %}
        </div>
      </aside>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/watch-page.js') }}"></script>
{% endblock %}
