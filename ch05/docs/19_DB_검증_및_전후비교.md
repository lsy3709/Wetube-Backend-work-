# DB 검증 – 테스트 전/후 데이터베이스 비교

단위 테스트가 실제 DB에 어떻게 반영되는지 확인할 수 있는 도구입니다.

---

## 실행 순서 (데이터베이스 확인)

### 방법 A: 전/후 비교 HTML 리포트 (권장)

| 순서 | 작업 | 명령 |
|------|------|------|
| 1 | 프로젝트 폴더 이동 | `cd C:\Wetube\ch05` |
| 2 | 검증 스크립트 실행 | `python scripts/db_verify.py` |
| 3 | 리포트 확인 | 브라우저 자동 오픈 또는 `instance/db_verify_report.html` |

### 방법 B: Flask 앱에서 리포트 보기

| 순서 | 작업 | 명령 |
|------|------|------|
| 1 | 앱 실행 | `flask run` |
| 2 | 검증 스크립트 실행 | `python scripts/db_verify.py` (별도 터미널) |
| 3 | 앱에서 리포트 접속 | http://127.0.0.1:5000/admin/db-verify |

### 방법 C: pytest + 파일 DB 후 수동 확인

| 순서 | 작업 | 명령 |
|------|------|------|
| 1 | 파일 DB로 테스트 실행 | `$env:USE_TEST_DB_FILE=1; python -m pytest tests/test_api.py -v` |
| 2 | sqlite3로 DB 조회 | `sqlite3 instance/test_pytest.db` |
| 3 | SQL 실행 | `.tables` 또는 `SELECT * FROM videos;` |

### 방법 D: 실제 DB(instance/wetube.db) 확인

| 순서 | 작업 | 명령 |
|------|------|------|
| 1 | sqlite3 실행 | `sqlite3 instance/wetube.db` |
| 2 | 테이블/데이터 조회 | `.tables` / `SELECT id, title, views FROM videos;` |

---

## 1. DB 검증 스크립트 (전/후 HTML 화면)

```powershell
python scripts/db_verify.py
```

### 동작
- `instance/test_verify.db` 에 검증용 DB 생성
- 시나리오 실행 (기본: 조회수 증가 `GET /api/videos/<id>`)
- **테스트 전** 스냅샷 → API 호출 → **테스트 후** 스냅샷
- `instance/db_verify_report.html` 생성 후 브라우저 자동 오픈

### 옵션
```powershell
python scripts/db_verify.py --scenario views    # 조회수 증가 (기본)
python scripts/db_verify.py --scenario subscribe  # 구독 토글
python scripts/db_verify.py --no-open          # 브라우저 자동 열기 생략
```

### 리포트 내용
- **변경 내역**: 변경된 컬럼 (예: views 10 → 11)
- **API 응답**: 호출한 API의 JSON 결과
- **테이블별 데이터**: users, videos, tags, video_tags, subscriptions 전/후 비교

---

## 2. Flask 앱에서 리포트 보기

Flask 앱 실행 후 아래 주소로 접속:

```
http://127.0.0.1:5000/admin/db-verify
```

- 리포트가 있으면 바로 표시
- 없으면 `python scripts/db_verify.py` 실행 안내

---

## 3. pytest 시 파일 DB 사용 (테스트 후 수동 검증)

테스트를 **파일 DB**로 실행한 뒤 `sqlite3` 또는 DB Browser로 직접 확인:

```powershell
$env:USE_TEST_DB_FILE=1; python -m pytest tests/test_api.py -v
```

- DB 파일: `instance/test_pytest.db`
- 테스트 종료 후 DB가 남아 있음

```powershell
sqlite3 instance/test_pytest.db
```

```sql
.tables
SELECT id, title, views FROM videos;
```

---

## 4. 실제 데이터 (instance/wetube.db)

프로덕션/개발 DB 검증:

```powershell
sqlite3 instance/wetube.db ".tables"
sqlite3 instance/wetube.db "SELECT id, title, views FROM videos LIMIT 5;"
```

또는 `flask shell`:

```python
from app.models import Video
Video.query.order_by(Video.views.desc()).limit(5).all()
```

---

## 5. 추천 도구

| 도구 | 용도 |
|------|------|
| **sqlite3** | 터미널에서 SQL 실행 |
| **DB Browser for SQLite** | GUI로 스키마·데이터 탐색 |
| **VS Code SQLite 확장** | 에디터에서 `.db` 파일 조회 |
