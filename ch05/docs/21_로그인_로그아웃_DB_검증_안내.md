# 로그인·로그아웃 데이터베이스 검증 안내

로그인·로그아웃 기능을 데이터베이스와 연계해 확인하는 방법과 진행 순서를 안내합니다.

---

## 1. 중요한 점: 로그인 상태는 DB에 저장되지 않음

| 구분 | 저장 위치 | DB 확인 가능 여부 |
|------|-----------|-------------------|
| **회원 정보** (사용자명, 이메일, 비밀번호 해시 등) | `users` 테이블 | ✅ 가능 |
| **로그인 상태** (현재 로그인한 사용자) | 브라우저 **세션 쿠키** | ❌ 불가능 |

- Flask-Login은 **세션 쿠키**에 사용자 ID를 저장합니다.
- 로그인/로그아웃은 쿠키의 유무·값 변경으로 동작하며, **DB에는 기록되지 않습니다.**

따라서 DB로 확인할 수 있는 것은 **회원가입으로 저장된 사용자 데이터**입니다.

---

## 2. DB에서 확인할 수 있는 것 (`users` 테이블)

| 컬럼 | 설명 |
|------|------|
| `id` | 사용자 고유 ID (PK) |
| `username` | 로그인 ID (사용자명) |
| `email` | 이메일 |
| `password_hash` | 비밀번호 해시 (평문은 저장되지 않음) |
| `nickname` | 닉네임 (선택) |
| `is_admin` | 관리자 여부 |
| `created_at`, `updated_at` | 생성·수정 시각 |

**회원가입** → `users` 테이블에 새 행 추가  
**로그인/로그아웃** → `users` 테이블 내용 변화 없음 (세션 쿠키만 변경)

---

## 3. 로그인·로그아웃 검증 진행 순서

### 3-1. 사전 준비

```powershell
# 1. 프로젝트 폴더로 이동
cd C:\Wetube\ch05

# 2. (선택) 가상환경 활성화
.\venv\Scripts\Activate.ps1

# 3. 앱 실행
flask run
```

브라우저에서 `http://127.0.0.1:5000` 접속.

---

### 3-2. 순서 1: 회원가입 전 `users` 테이블 확인

**sqlite3 CLI로 조회**

```powershell
sqlite3 instance/wetube.db "SELECT id, username, email, created_at FROM users;"
```

또는 sqlite3 프롬프트에서:

```bash
sqlite3 instance/wetube.db
```

```sql
SELECT id, username, email, created_at FROM users;
```

**기대 결과**: 기본 사용자 `default` (id=1) 존재.

---

### 3-3. 순서 2: 회원가입 수행

1. 브라우저에서 `http://127.0.0.1:5000/auth/register` 접속
2. 다음 값 입력 후 **회원가입** 클릭:
   - 사용자명: `testuser`
   - 이메일: `test@example.com`
   - 비밀번호: `test1234`
   - 비밀번호 확인: `test1234`
3. 회원가입 완료 시 홈으로 리다이렉트되며 자동 로그인됨.

---

### 3-4. 순서 3: 회원가입 후 `users` 테이블 확인

```sql
SELECT id, username, email, nickname, created_at FROM users;
```

**기대 결과**: `testuser` / `test@example.com` 행 추가됨.

| id | username | email |
|----|----------|-------|
| 1 | default | default@example.com |
| 2 | testuser | test@example.com |

`password_hash` 컬럼에는 `scrypt:...` 형태의 해시만 저장되고, 평문 비밀번호는 저장되지 않음.

---

### 3-5. 순서 4: 로그아웃 후 쿠키 확인

1. 브라우저에서 **로그아웃** 클릭 (아바타 → 로그아웃).
2. 개발자 도구(F12) → **Application** → **Cookies** → `http://127.0.0.1:5000`
3. **session** 쿠키:
   - 로그인 시: 존재함
   - 로그아웃 후: 삭제되거나 값이 비어 있음

> 로그인 상태는 DB가 아닌 **쿠키**로만 확인 가능합니다.

---

### 3-6. 순서 5: 로그인 (사용자명 또는 이메일)

1. `/auth/login` 접속
2. **아이디/이메일**: `testuser` 또는 `test@example.com` (둘 다 가능)
3. **비밀번호**: `test1234`
4. **로그인 유지** 체크 시: 브라우저 닫았다 열어도 로그인 유지
5. 로그인 성공 시 홈으로 이동.

---

### 3-7. 순서 6: 로그인 후 DB 확인

```sql
SELECT id, username, email FROM users;
```

**기대 결과**: `users` 테이블은 **로그인 전후로 동일**함.  
로그인/로그아웃은 DB를 변경하지 않고, 세션 쿠키만 사용합니다.

---

## 4. DB 조회 명령어 요약

| 목적 | 명령어 |
|------|--------|
| users 테이블 전체 | `sqlite3 instance/wetube.db "SELECT id, username, email FROM users;"` |
| 비밀번호 해시 확인 (저장 형태만) | `sqlite3 instance/wetube.db "SELECT id, username, LEFT(password_hash, 20) FROM users;"` |
| 가독성 있는 출력 | `sqlite3 -header -column instance/wetube.db "SELECT id, username, email FROM users;"` |
| DB Browser로 확인 | [DB Browser for SQLite](https://sqlitebrowser.org/)로 `instance/wetube.db` 열기 |

---

## 5. Flask Shell로 `users` 확인

```powershell
flask shell
```

```python
>>> from app.models import User
>>> User.query.all()
# [<User default>, <User lsy>, ...]

>>> u = User.query.filter_by(username='lsy').first()
>>> u.email
# 'lsy@example.com' (등록한 이메일)

>>> u.check_password('1234')
# True
```

`check_password()`로 해당 비밀번호가 해시와 일치하는지 검증할 수 있습니다.

---

## 6. 진행 순서 한눈에 보기

```
1. 앱 실행 (flask run)
       ↓
2. 회원가입 전 users 확인 (sqlite3)
       ↓
3. /auth/register 에서 회원가입
       ↓
4. 회원가입 후 users 확인 (새 행 추가됨)
       ↓
5. 로그아웃 → 쿠키(Application 탭)에서 session 확인
       ↓
6. /auth/login 에서 로그인 (username 또는 email)
       ↓
7. 로그인 후 users 확인 (변화 없음 – 로그인은 DB에 기록 안 됨)
       ↓
8. Studio 접속 → 로그인된 사용자 소유 영상만 표시
```

---

## 7. 정리

| 확인 대상 | 방법 |
|-----------|------|
| **회원 데이터**(가입·수정) | DB `users` 테이블 조회 |
| **로그인 상태** | 브라우저 쿠키(Application → session) 확인 |
| **비밀번호 검증** | Flask Shell에서 `user.check_password('비밀번호')` |
| **단위 테스트** | `python -m pytest tests/test_auth_login.py tests/test_auth_register.py -v` |
