# 댓글·대댓글 데이터베이스 확인 전략

댓글 및 대댓글(답글) 기능이 데이터베이스에 올바르게 반영되는지 확인하는 방법과 전략을 정리합니다.

---

## 1. 확인 대상: `comments` 테이블

### 1-1. 테이블 구조 (table.sql 기준)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| `id` | INTEGER | PK, 자동 증가 |
| `content` | TEXT | 댓글 내용 |
| `user_id` | INTEGER | FK → users.id (작성자) |
| `video_id` | INTEGER | FK → videos.id |
| `parent_id` | INTEGER NULL | FK → comments.id (대댓글인 경우 부모 댓글 ID) |
| `likes` | INTEGER | 기본 0 |
| `dislikes` | INTEGER | 기본 0 |
| `created_at` | TIMESTAMP | 최초 작성 시각 |
| `updated_at` | TIMESTAMP | 수정 시 갱신 |

### 1-2. 핵심 검증 포인트

| 기능 | DB 확인 항목 |
|------|--------------|
| **댓글 작성** | `parent_id IS NULL`, `content`, `user_id`, `video_id` 저장 |
| **대댓글 작성** | `parent_id` = 부모 댓글 ID, `video_id`는 부모와 동일 |
| **댓글 수정** | `content`, `updated_at` 변경 |
| **댓글 삭제** | 해당 행이 DB에서 제거됨 |
| **최상위 조회** | `parent_id IS NULL`인 행만 최상위, 그 외는 대댓글 |

---

## 2. 확인 방법 요약

| 방법 | 명령/도구 | 용도 |
|------|-----------|------|
| **sqlite3 CLI** | `sqlite3 instance/wetube.db` | 빠른 조회, 스크립트 연동 |
| **DB Browser** | GUI로 `instance/wetube.db` 열기 | 시각적 확인, parent_id 구조 파악 |
| **Flask Shell** | `flask shell` 후 ORM | Comment 모델·관계 검증 |
| **pytest** | `python -m pytest tests/test_comments.py -v` | 반복 가능한 자동 검증 |
| **파일 DB 검증** | `USE_TEST_DB_FILE=1` + sqlite3 | 테스트 후 수동 DB 확인 |

---

## 3. 검증 전략 (3단계)

### 전략 A: 화면 작업 후 직접 DB 확인 (수동)

1. **flask run** 후 브라우저에서 watch 페이지 접속
2. 로그인 → 댓글 작성 → sqlite3/DB Browser로 `comments` 확인
3. 답글 작성 → `parent_id` 값 확인
4. 수정/삭제 → 해당 레코드 변경/삭제 확인

### 전략 B: pytest 단위 테스트 (자동)

- `tests/test_comments.py`가 각 라우트의 DB 반영을 assert로 검증
- `db.session.get(Comment, id)` 등으로 레코드 존재·내용 확인

### 전략 C: 파일 DB로 테스트 후 수동 확인

- `USE_TEST_DB_FILE=1`로 pytest 실행 → `instance/test_pytest.db` 생성
- sqlite3로 `comments` 테이블 조회

---

## 4. 진행 순서 (화면 → DB 확인)

### 4-1. 사전 준비

```powershell
cd C:\Wetube\ch05
flask run
```

브라우저에서 비디오 시청 페이지(`/watch/<video_id>`) 접속 후 로그인.

### 4-2. 순서 1: 댓글 작성 전 comments 확인

```powershell
sqlite3 -header -column instance/wetube.db "SELECT id, content, user_id, video_id, parent_id FROM comments;"
```

또는 비디오 ID 기준:

```sql
SELECT id, content, user_id, video_id, parent_id, created_at 
FROM comments 
WHERE video_id = 1 
ORDER BY parent_id NULLS FIRST, created_at;
```

### 4-3. 순서 2: 댓글 작성 후 DB 확인

1. watch 페이지에서 댓글 입력 후 제출
2. DB 확인:

```sql
SELECT id, content, user_id, video_id, parent_id 
FROM comments 
WHERE video_id = ? 
  AND parent_id IS NULL 
ORDER BY created_at ASC;
```

**기대:** 새 행 추가, `parent_id` = NULL, `user_id` = 로그인 사용자 ID

### 4-4. 순서 3: 대댓글 작성 후 DB 확인

1. 기존 댓글의 **답글** 버튼 클릭 → 답글 입력 후 제출
2. DB 확인:

```sql
SELECT id, content, user_id, video_id, parent_id 
FROM comments 
WHERE parent_id IS NOT NULL;
```

**기대:** `parent_id`가 부모 댓글 `id`와 일치, `video_id`는 부모와 동일

### 4-5. 순서 4: 댓글 수정 후 DB 확인

1. 본인 댓글의 **수정** 클릭 → 내용 변경 후 저장
2. DB 확인:

```sql
SELECT id, content, updated_at FROM comments WHERE id = ?;
```

**기대:** `content`, `updated_at` 변경

### 4-6. 순서 5: 댓글 삭제 후 DB 확인

1. 본인 댓글의 **삭제** 클릭 → 확인
2. DB 확인:

```sql
SELECT * FROM comments WHERE id = ?;
```

**기대:** 해당 행 없음 (빈 결과)

---

## 5. DB 조회 명령어 요약

### sqlite3 CLI

```powershell
sqlite3 instance/wetube.db
```

```sql
.mode column
.headers on

-- 전체 댓글 (최상위 → 대댓글 순)
SELECT id, content, user_id, video_id, parent_id, created_at 
FROM comments 
ORDER BY COALESCE(parent_id, id), parent_id, created_at;

-- 특정 비디오의 최상위 댓글만
SELECT id, content, user_id, parent_id 
FROM comments 
WHERE video_id = 1 AND parent_id IS NULL 
ORDER BY created_at ASC;

-- 대댓글 개수
SELECT parent_id, COUNT(*) AS reply_count 
FROM comments 
WHERE parent_id IS NOT NULL 
GROUP BY parent_id;
```

### Flask Shell

```python
from app import db
from app.models import Comment, User, Video

# 최상위 댓글 (parent_id=None), created_at 오름차순
top = Comment.query.filter_by(video_id=1, parent_id=None).order_by(Comment.created_at.asc()).all()
for c in top:
    print(c.id, c.content, c.replies)  # replies: 대댓글 목록
```

---

## 6. pytest 연동

```powershell
# 댓글 기능 전용 테스트 (in-memory DB)
python -m pytest tests/test_comments.py -v

# 파일 DB 사용 시 (테스트 후 instance/test_pytest.db 확인)
$env:USE_TEST_DB_FILE=1; python -m pytest tests/test_comments.py -v
sqlite3 instance/test_pytest.db "SELECT * FROM comments;"
```

---

## 7. db_verify.py 연동

`scripts/db_verify.py`는 `comments` 테이블을 기본 테이블 목록에 포함할 수 있습니다.  
(테이블 목록: users, videos, tags, video_tags, subscriptions, **comments**)

전/후 비교 시나리오에 댓글 추가·삭제를 포함하면, 리포트에서 `comments` 변화를 확인할 수 있습니다.
