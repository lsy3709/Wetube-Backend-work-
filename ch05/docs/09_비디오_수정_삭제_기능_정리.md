# 비디오 수정(Update) / 삭제(Delete) 기능 – 코드 확인 및 책 원고용 정리

## 1. 구현된 코드 위치

| 구분 | 파일 | 역할 |
|------|------|------|
| 백엔드 | `app/routes/studio.py` | 수정·삭제 라우트 (edit, delete) |
| 템플릿 | `app/templates/studio/edit.html` | 수정 폼 + 삭제 폼 UI |
| 프론트 | `app/static/js/studio-edit-page.js` | 제출·삭제 확인·중복 방지 |
| 모델 | `app/models/video.py` | Video 엔티티, save_tags (수정 시 태그 반영) |

---

## 2. 각 코드의 핵심 내용

### 2.1 수정 라우트 `edit(video_id)` (studio.py)

- **경로**: `GET|POST /studio/edit/<int:video_id>`
- **GET**: 해당 비디오로 `edit.html` 렌더 (제목·설명·카테고리·태그 등 기존 값 채움).
- **POST**:
  - `title`, `description` 필수/길이 검증 (제목 200자 이하).
  - `video.title`, `video.description`, `video.category` 갱신.
  - `video.save_tags(tags_str, commit=False)` 로 태그 연결 갱신 후 `db.session.commit()`.
  - 성공 시 **상세(시청) 페이지로 리다이렉트**: `redirect(url_for("main.watch", video_id=video.id))`.
- **방어**: `Video.query.get_or_404(video_id)` 로 없으면 404.

### 2.2 삭제 라우트 `delete(video_id)` (studio.py)

- **경로**: `POST /studio/delete/<int:video_id>` (GET 없음, 삭제는 POST만).
- **순서 (필수)**:
  1. 레코드 조회 후 `video_path`, `thumbnail_path` 변수에 보관.
  2. `db.session.delete(video)` → `db.session.commit()`.
  3. commit 실패 시 `rollback`, flash 에러, `studio.edit` 로 리다이렉트.
  4. **commit 성공 후**에만 `VIDEO_FOLDER`/`THUMBNAIL_FOLDER`에서 해당 파일 `os.remove()` 시도.
- **고아 파일 대응**: 파일이 없어도 `os.remove()` 시 `OSError`는 `try/except`로 무시하여 DB 삭제는 항상 완료되도록 처리.
- **결과**: 성공 시 flash 후 `redirect(url_for("studio.index"))`.

### 2.3 수정 페이지 템플릿 (edit.html)

- **수정 폼** (`id="edit-form"`): `method="post"`, `action="{{ url_for('studio.edit', video_id=video.id) }}"`. 제목·설명·카테고리·태그·공개설정 등 포함.
- **삭제 폼** (`id="delete-form"`): 별도 form, `method="post"`, `action="{{ url_for('studio.delete', video_id=video.id) }}"`, 안에 삭제 버튼만 존재.
- **저장 버튼**: `form="edit-form"` 으로 edit-form을 제출. 취소/저장은 오른쪽, 삭제는 왼쪽 배치.

### 2.4 프론트엔드 (studio-edit-page.js)

- **저장(수정)**:
  - submit 시 제목 비어 있으면 `preventDefault` + 에러 메시지.
  - 제목 있으면 **제출 버튼 비활성화** + "저장 중..." 표시 후 **폼 그대로 제출** (중복 제출 방지).
  - 이미 `submitBtn.disabled === true` 이면 `preventDefault`로 한 번만 전송.
- **삭제**:
  - `#delete-form`의 `submit` 이벤트에서 `preventDefault` → `confirm("정말 삭제하시겠습니까?...")` → 취소 시 return.
  - 확인 시 삭제 버튼 비활성화 + "삭제 중..." → `deleteForm.submit()` 호출 (중복 클릭 방지).

---

## 3. 책 원고용 축약본

### 3.1 개요

- **수정**: 비디오 ID로 접근한 수정 페이지에서 제목·설명·카테고리·태그를 변경하고, 저장 시 DB 반영 후 **상세(시청) 페이지**로 이동한다.
- **삭제**: 삭제 버튼 클릭 시 확인창을 띄운 뒤, **DB 레코드를 먼저 삭제**하고, 성공한 경우에만 서버 `uploads/`(비디오·썸네일) 파일을 삭제한다. 파일이 이미 없어도 DB 삭제는 완료되도록 예외를 무시한다.
- **안전**: 삭제 전 "정말 삭제하시겠습니까?" 확인창, 수정·삭제 시 버튼 비활성화로 중복 제출·중복 클릭을 막는다.

### 3.2 백엔드 요약

- **edit**: GET은 수정 폼 표시, POST는 유효성 검사 후 `Video` 필드 및 `save_tags()`로 갱신하고 `main.watch`로 리다이렉트.
- **delete**: POST 전용. DB delete → commit 성공 후에만 비디오/썸네일 파일 삭제 시도. 파일 삭제 시 `OSError`는 무시(고아 파일·이미 삭제된 파일 대비).

### 3.3 프론트엔드 요약

- 수정: 제목 검사 후 제출 시 버튼 비활성화 및 "저장 중..." 표시, 이미 비활성화된 경우 재전송 차단.
- 삭제: submit 시 확인 대화상자 → 확인 시 버튼 비활성화 및 "삭제 중..." 후 폼 제출, 한 번만 전송되도록 처리.

### 3.4 설계 포인트 (책에서 강조할 만한 내용)

1. **삭제 순서**: DB 먼저, 파일 나중. DB 실패 시 파일은 건드리지 않아 일관성이 유지된다.
2. **고아 파일**: 파일이 없어도 `os.remove()` 예외를 잡아서 DB 삭제는 성공으로 끝나게 한다.
3. **레이스 컨디션 방지**: 수정·삭제 모두 제출/클릭 시 버튼을 즉시 비활성화해 이중 전송을 막는다.
4. **삭제 확인**: 실제 삭제 요청 전에 `confirm()`으로 사용자 확인을 받는다.

---

*이 문서는 기능 구현 코드 확인 후 책 원고용으로 축약한 정리본입니다.*
