# 12. 단위 테스트 명령어 및 프롬프트

---

## 가상환경(venv)에서 pytest 실행하기 – 단계별 안내

아래는 **처음 해보는 사람**을 위한 순서입니다. 터미널에 **한 줄씩** 입력하면 됩니다.

### 1단계: 터미널 열기

- Cursor / VS Code: 상단 메뉴 **터미널 → 새 터미널** (또는 `` Ctrl+` ``)
- 또는 Windows **PowerShell** / **명령 프롬프트(CMD)** 를 직접 실행

---

### 2단계: 프로젝트 폴더로 이동

**쳐야 할 명령어**
```powershell
cd c:\Wetube\ch05
```
**설명:** `ch05` 폴더 안으로 들어가는 명령입니다. 프로젝트 루트가 다른 경로라면 그 경로로 바꿔서 입력하세요.  
**성공 시:** 다음 줄에 `c:\Wetube\ch05` 같은 경로가 보이거나, 프롬프트가 `PS C:\Wetube\ch05>` 처럼 바뀝니다.

---

### 3단계: 가상환경(venv) 켜기

**PowerShell 인 경우**
```powershell
.\venv\Scripts\Activate.ps1
```
**CMD(명령 프롬프트) 인 경우**
```cmd
venv\Scripts\activate.bat
```

**설명:** 이 프로젝트 전용 Python 환경(venv)을 사용하도록 켜는 단계입니다.  
**성공 시:** 맨 앞에 `(venv)` 가 붙습니다. 예: `(venv) PS C:\Wetube\ch05>`

**실행 정책 오류가 나는 경우 (PowerShell):**  
`이 스크립트를 실행할 수 없습니다...` 라고 나오면, 한 번만 아래를 실행한 뒤 다시 3단계를 시도하세요.
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

---

### 4단계: pytest 실행

**전체 테스트 실행 (한 줄만)**
```powershell
pytest
```
**테스트 이름까지 보이게 실행 (추천)**
```powershell
pytest -v
```

**설명:** `tests/` 폴더 안의 테스트를 자동으로 찾아서 실행합니다.  
**성공 시:** 마지막에 `6 passed` 같은 문구가 나오고, 각 테스트가 `PASSED` 로 표시됩니다.

---

### 5단계: (선택) 특정 테스트 파일만 실행

**이 파일만 실행**
```powershell
pytest tests/test_studio_upload.py -v
```
**이 파일의 특정 테스트 하나만 실행**
```powershell
pytest tests/test_studio_upload.py::test_allowed_file_accepts_mp4 -v
```

---

### 한 번에 복사해서 쓸 수 있는 순서 (PowerShell)

아래를 **한 번에** 복사해서 터미널에 붙여 넣고 Enter 하면, 2→3→4단계가 순서대로 실행됩니다.
```powershell
cd c:\Wetube\ch05
.\venv\Scripts\Activate.ps1
pytest -v
```

---

### 자주 나오는 상황 정리

| 상황 | 확인할 것 |
|------|------------|
| `pytest` 를 찾을 수 없다고 나옴 | 3단계에서 가상환경이 켜졌는지 확인. 프롬프트 앞에 `(venv)` 가 있어야 함. |
| **`No module named 'app'`** | **ch05 폴더에 `pytest.ini` 가 있는지 확인.** 있으면 `pythonpath = .` 로 프로젝트 루트가 경로에 포함됨. 없으면 프로젝트 루트에 `pytest.ini` 를 만들고 `[pytest]` 아래에 `pythonpath = .` 를 넣으면 해결됨. |
| 테스트가 0개 collected | `tests/test_studio_upload.py` 파일이 `ch05` 아래에 있는지 확인. |

---

## 5.1.5 단위 테스트 실행 명령어

프로젝트에 `pytest`, `pytest-cov` 가 포함되어 있음. 가상환경 활성화 후 아래 명령 사용.

| 목적 | 명령어 (ch05 폴더 기준) |
|------|--------------------------|
| 전체 테스트 실행 | `pytest` |
| 상세 출력 (print 포함) | `pytest -v` 또는 `pytest -s` |
| 특정 파일만 | `pytest tests/test_studio_upload.py` |
| 특정 함수만 | `pytest tests/test_studio_upload.py::test_allowed_file_accepts_mp4` |
| 커버리지 리포트 | `pytest --cov=app --cov-report=term-missing` |
| 실패 시 중단 | `pytest -x` |

**가상환경 활성화 후 예시**
```powershell
cd c:\Wetube\ch05
.\venv\Scripts\Activate.ps1
pytest -v
```

---

## 화면 미연결 가정 – 업로드·확장자 검증 테스트용 프롬프트 추천

아직 화면(프론트)을 연결하지 않았다고 가정하고, **비디오 업로드·확장자·용량 검증**을 단위 테스트로 확인하고 싶을 때 아래 프롬프트를 참고해 사용하면 됨.

### 1) 테스트 코드 생성 요청

- **"app/routes/studio.py 의 _allowed_file, _save_upload_file 함수에 대한 단위 테스트를 tests/test_studio_upload.py 에 작성해줘. 허용 확장자(mp4, webm, mov) 통과·거부, 빈 파일명, 용량 초과, 확장자 없음 케이스를 포함해줘."**
- **"Flask test client로 POST /studio/upload 요청을 보내서, 제목 없을 때 400과 flash 메시지, 정상 업로드 시 302 리다이렉트와 DB에 Video 레코드가 생기는지 검증하는 테스트 코드를 작성해줘. 화면은 사용하지 않고 요청/응답만 테스트해줘."**

### 2) 확장자·검증 로직만 테스트

- **"studio.py 의 _allowed_file 이 mp4/webm/mov 일 때 True, avi/mkv 일 때 False, filename이 None이거나 확장자가 없을 때 False 를 반환하는 pytest 테스트를 작성해줘."**
- **"config 의 ALLOWED_VIDEO_EXTENSIONS, MAX_VIDEO_SIZE 를 사용해 _save_upload_file 이 허용 확장자 거부·용량 초과 시 (None, 에러메시지) 를 반환하는지 단위 테스트로 확인하는 코드를 작성해줘."**

### 3) 업로드 API(라우트) 통합 테스트

- **"화면 없이 Flask test client로 /studio/upload 에 POST 요청을 보내서, (1) 제목 없음 → 400, (2) 비디오 파일 없음 → 400, (3) 허용되지 않은 확장자(.avi) → 400, (4) 제목+mp4 파일 제출 → 302 리다이렉트 + DB에 Video 한 건 생성 되는지 pytest로 검증하는 테스트를 작성해줘."**

### 4) 테스트 실행 방법만 물어볼 때

- **"ch05 프로젝트에서 pytest로 단위 테스트 실행하는 명령어 알려줘. 가상환경은 venv 사용해."**
- **"pytest로 특정 테스트 파일만 실행하는 명령어 알려줘."**

---

## 요약

| 구분 | 내용 |
|------|------|
| **실행** | `pytest`, `pytest -v`, `pytest tests/test_studio_upload.py` |
| **프롬프트** | _allowed_file / _save_upload_file 단위 테스트, test client로 POST /studio/upload 검증, 확장자·용량·제목 검증 케이스 요청 |
| **가정** | 화면(프론트) 미연결, Flask 앱 + test client로 요청/응답·DB만 검증 |

실제 테스트 코드 예시는 **`tests/test_studio_upload.py`** 참고.  
- `tests/conftest.py`: pytest 픽스처 (app, client).  
- `tests/test_studio_upload.py`: `_allowed_file` 확장자 검증 테스트 (mp4/webm/mov 허용, avi/mkv/None/빈문자열/확장자없음 거부, 대소문자).
