# 5.4.6 데이터베이스 확인 – 책 원고용

## 1. 개요

구현한 기능(업로드·수정·삭제·통계)이 실제로 DB에 반영되는지 확인하는 방법을 정리한다.

**스튜디오 기능 확인의 핵심은 조회이다.** 화면에 표시되는 동영상 수·조회수·수정 반영 여부는 결국 DB의 `videos` 테이블 내용을 조회한 결과이다. 따라서 **스튜디오 기능 검증에는 데이터베이스 확인을 권장한다.** GUI·CLI·Flask Shell·단위 테스트를 활용할 수 있다.

---

## 2. DB 파일 위치

| 항목 | 내용 |
|------|------|
| 기본 파일 | `instance/wetube.db` (프로젝트 루트 기준) |
| 경로 확인 | 앱 실행 시 터미널에 `[DB] 사용 중: C:\...\instance\wetube.db` 출력 |
| 환경변수 | `DATABASE_URL` 설정 시 해당 URI의 파일 사용 |

---

## 3. 사전 준비

- **프로젝트 루트**: `ch05` 폴더 (또는 `app` 폴더가 있는 상위 디렉터리)
- **DB 파일**: `instance/wetube.db` (앱 실행 후 생성됨)
- **sqlite3**: Windows는 별도 설치 또는 Python 설치 경로의 `sqlite3.exe` 사용 가능. macOS/Linux는 기본 내장.

---

## 4. 실제 쿼리를 이용한 조회 명령어

### 4.1 sqlite3 CLI로 DB 열기

터미널(PowerShell, CMD, bash 등)에서 프로젝트 루트로 이동 후 실행:

```bash
sqlite3 instance/wetube.db
```

`sqlite>` 프롬프트가 나오면 SQL 입력 가능.

---

### 4.2 테이블·스키마 확인

```sql
-- 테이블 목록
.tables

-- videos 테이블 구조 확인
.schema videos

-- users 테이블 구조 확인
.schema users
```

---

### 4.3 videos 테이블 조회 (실제 쿼리)

```sql
-- 전체 동영상 조회 (기본 컬럼)
SELECT id, title, description, user_id, views, created_at FROM videos;

-- 전체 동영상 조회 (모든 컬럼)
SELECT * FROM videos;

-- 특정 ID 동영상 조회 (수정·삭제 확인용)
SELECT id, title, description, category, views FROM videos WHERE id = 1;

-- 특정 사용자(user_id=1) 동영상만 조회
SELECT id, title, views FROM videos WHERE user_id = 1 ORDER BY created_at DESC;

-- 영상 개수·총 조회수 (스튜디오 대시보드 통계와 비교)
SELECT
  COUNT(*) AS video_count,
  COALESCE(SUM(views), 0) AS total_views
FROM videos
WHERE user_id = 1;

-- 최근 등록 동영상 5개
SELECT id, title, views, created_at FROM videos ORDER BY created_at DESC LIMIT 5;
```

---

### 4.4 users 테이블 조회

```sql
-- 전체 사용자
SELECT id, username, email, created_at FROM users;

-- 기본 사용자(id=1) 확인
SELECT id, username, email FROM users WHERE id = 1;
```

---

### 4.5 한 줄로 실행 (sqlite3 프롬프트 없이)

터미널에서 `sqlite3` 뒤에 쿼리를 붙여 실행:

```bash
sqlite3 instance/wetube.db "SELECT id, title, views FROM videos;"
```

여러 줄 쿼리는 세미콜론으로 연결:

```bash
sqlite3 instance/wetube.db "SELECT COUNT(*) AS video_count, COALESCE(SUM(views), 0) AS total_views FROM videos WHERE user_id = 1;"
```

**출력 형식 지정** (가독성 향상):

```bash
sqlite3 -header -column instance/wetube.db "SELECT id, title, views FROM videos;"
```

- `-header`: 컬럼명 출력
- `-column`: 열 맞춤 출력

---

### 4.6 sqlite3 종료

```sql
.quit
```

또는 `Ctrl+D` (Unix) / `Ctrl+Z` 후 Enter (Windows CMD).

---

## 5. 확인 방법별 안내

### 5.1 GUI: DB Browser for SQLite

- **도구**: [DB Browser for SQLite](https://sqlitebrowser.org/) 설치 후 `instance/wetube.db` 열기
- **확인 절차**:
  1. `데이터 보기` 탭에서 `videos`, `users` 등 테이블 선택
  2. 행·컬럼 값 확인 (업로드·수정·삭제 반영 여부)
- **원고 활용**: 스크린샷과 함께 "데이터가 의도대로 저장·변경·삭제되었는지 시각적으로 확인한다"고 서술

---

### 5.2 CLI: sqlite3 명령어 요약

| 목적 | 명령어 |
|------|--------|
| DB 열기 | `sqlite3 instance/wetube.db` |
| 테이블 목록 | `.tables` |
| videos 전체 조회 | `SELECT id, title, views FROM videos;` |
| 특정 사용자 통계 | `SELECT COUNT(*), COALESCE(SUM(views),0) FROM videos WHERE user_id=1;` |
| 한 줄 실행 | `sqlite3 instance/wetube.db "SELECT * FROM videos;"` |
| 종료 | `.quit` |

---

### 5.3 Python: Flask Shell

ORM으로 조회한다. 프로젝트 루트에서 `flask shell` 실행 후:

```bash
flask shell
```

**Flask Shell 내부 예시**

```python
>>> from app.models import Video
>>> from app import db
>>> from sqlalchemy import func

# 전체 비디오 목록
>>> Video.query.all()

# 특정 사용자 동영상 수
>>> Video.query.filter_by(user_id=1).count()

# 총 조회수 합계 (스튜디오 통계와 동일 쿼리)
>>> db.session.query(func.coalesce(func.sum(Video.views), 0)).filter(Video.user_id == 1).scalar()

# 특정 ID 동영상 조회 (수정·삭제 확인)
>>> v = Video.query.get(1)
>>> v.title if v else None
```

---

### 5.4 자동화: pytest 단위 테스트

DB 상태를 assert로 검증한다.

```bash
python -m pytest tests/test_studio_stats.py -v
python -m pytest tests/test_studio_edit_delete.py -v
```

- `_get_studio_stats` 호출 후 `total_views`, `video_count` 검증
- 수정·삭제 후 `Video.query.get(video_id)` 값 검증

---

## 6. 실습 예시 (원고용)

| 단계 | 확인 내용 | 실행할 SQL |
|------|-----------|------------|
| 업로드 후 | videos 테이블에 행 추가 | `SELECT id, title, user_id, views FROM videos;` |
| 수정 후 | title, description 등 컬럼 변경 | `SELECT id, title, description FROM videos WHERE id = 1;` |
| 삭제 후 | 해당 행 없음 | `SELECT * FROM videos WHERE id = 1;` (Empty result 확인) |
| 통계 | 총 조회수·영상 개수 | `SELECT COUNT(*) AS video_count, COALESCE(SUM(views), 0) AS total_views FROM videos WHERE user_id = 1;` |

**예시 실행 흐름** (업로드 후 확인)

```bash
# 1) sqlite3 실행
sqlite3 instance/wetube.db

# 2) 쿼리 입력
sqlite> SELECT id, title, user_id, views FROM videos;

# 3) 출력 예시
# 1|첫 동영상|1|0
# 2|두 번째|1|5

# 4) 종료
sqlite> .quit
```

---

## 7. 정리

- **스튜디오 기능 확인 = DB 조회**: 화면 표시 데이터는 DB 조회 결과이므로, 검증 시 데이터베이스 확인을 추천한다.
- **실제 쿼리**: `SELECT`, `COUNT`, `SUM` 등 SQL로 직접 조회해 데이터 존재·변경 여부를 확인한다.
- **GUI**: 직관적 확인, 독자용 실습·스크린샷에 적합
- **CLI**: `sqlite3 instance/wetube.db` + 위 §4의 쿼리로 빠른 조회
- **Flask Shell**: ORM·코드와 연계한 확인에 적합
- **pytest**: 반복 가능한 검증, 회귀 테스트에 적합

개발 단계별로 GUI/CLI/Shell/테스트 중 하나를 선택해 활용하면 된다.
