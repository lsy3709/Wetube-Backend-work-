# 스튜디오 대시보드 통계 기능 – 책 원고용 정리

## 1. 개요

스튜디오 대시보드에 표시할 통계(총 조회수, 영상 개수)를 **DB 집계 함수**로 한 번에 계산하는 기능이다. Python 리스트로 불러와 세지 않고, SQL의 `SUM`, `COUNT`를 활용해 DB 레벨에서 집계한다.

---

## 2. 구현된 코드 위치

| 구분 | 파일 | 역할 |
|------|------|------|
| 백엔드 | `app/routes/studio.py` | `_get_studio_stats(user_id)` 함수, `index` 라우트 |
| 템플릿 | `app/templates/studio/index.html` | 통계 카드 UI (동영상 수, 조회수) |

---

## 3. 핵심 구현 내용

### 3.1 `_get_studio_stats(user_id)` 함수

**역할**  
로그인한 사용자(또는 기본 사용자)의 총 조회수 합계와 영상 개수를 DB에서 한 번에 조회해 반환한다.

**반환**  
`(total_views, video_count)` 튜플. 데이터가 없으면 `(0, 0)`.

**쿼리 예시 (개념)**  
```sql
SELECT COALESCE(SUM(views), 0) AS total_views,
       COUNT(id) AS video_count
FROM videos
WHERE user_id = ?
```

**핵심 포인트**  
- `func.sum(Video.views)` : 조회수 합계. 행이 없으면 SQL `SUM`은 `NULL` 반환 → `func.coalesce(..., 0)`으로 0 치환.
- `func.count(Video.id)` : 영상 개수. 행이 없어도 `COUNT`는 0 반환.
- `row is None` 또는 컬럼 값 `None` 대비: 반환 시 `int(...) if ... is not None else 0` 처리.

### 3.2 `index` 라우트 적용

- `_current_user_id()`로 현재 사용자 ID 조회 (로그인 미구현 시 `config["DEFAULT_USER_ID"]` 사용).
- `_get_studio_stats(user_id)` 호출로 `total_views`, `video_count` 획득.
- 템플릿에 `video_count`, `total_views` 전달하여 대시보드 카드에 표시.

---

## 4. 설계 포인트 (책에서 강조할 만한 내용)

1. **DB 집계 vs Python 집계**  
   - `sum(v.views for v in videos)`, `len(videos)` 대신 `func.sum`, `func.count` 사용 → 네트워크 전송량·메모리 사용 감소, DB 최적화 활용.

2. **NULL·빈 결과 처리**  
   - `SUM`이 빈 집합에 대해 `NULL`을 반환할 수 있으므로 `COALESCE` 또는 `None` 체크로 0 치환.

3. **로그인 미구현 대응**  
   - `user_id`는 `_current_user_id()`로 주입. 로그인 연동 시 `current_user.id`로 교체하면 된다.

---

*이 문서는 스튜디오 대시보드 통계 기능 구현 후 책 원고용으로 정리한 내용이다.*
