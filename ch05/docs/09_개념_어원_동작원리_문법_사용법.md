# 09. 개념·어원·동작 원리·문법·사용법 종합

현재까지 작업 내용, 기능, 코드 주석 요약, 사용된 개념·어원·동작 원리, 기본 문법·사용법을 한 문서로 정리한다.

---

## 1. 현재까지 작업 내용·기능 요약

### 1.1 구현된 기능

| 기능                     | 설명                                                                                          | 관련 파일                                           |
| ------------------------ | --------------------------------------------------------------------------------------------- | --------------------------------------------------- |
| 비디오·썸네일 업로드     | 제목·비디오(필수), 설명·썸네일(선택) → 검증 후 저장, DB 기록                                  | `studio.py`, `upload.html`, `studio-upload-page.js` |
| Studio 로그인 미연동     | 로그인 없이 `/studio`, `/studio/upload`, `/studio/edit` 접근 가능                             | `base.html`, `studio/*.html`, `studio-*.js`         |
| 헤더 Studio 링크         | 비로그인 시에도 헤더에 "Studio" 버튼 노출                                                     | `base.html`                                         |
| 기본 사용자( user_id=1 ) | 업로드 시 `config.DEFAULT_USER_ID`(1) 사용, 앱 기동 시 없으면 default 유저 생성               | `__init__.py`, `studio.py`                          |
| Flask 앱 팩토리          | `create_app()` 으로 앱 생성, Blueprint 등록, DB·업로드 폴더 초기화                            | `app/__init__.py`                                   |
| 실행·문서화              | `flask run` / `python -m app`, Python 3.13 호환(SQLAlchemy>=2.0.36), 체크리스트·프롬프트 기록 | `06`, `07`, `08`, `requirements.txt`                |

### 1.2 디렉터리·파일 역할 요약

| 경로                                   | 역할                                                                 |
| -------------------------------------- | -------------------------------------------------------------------- |
| `app/__init__.py`                      | 앱 팩토리, config, db, Blueprint 등록, `create_all()`·기본 유저 생성 |
| `app/__main__.py`                      | `python -m app` 진입점, `app.run()` 호출                             |
| `app/models/`                          | User, Video 모델 (SQLAlchemy)                                        |
| `app/routes/`                          | main, auth, studio, admin Blueprint 라우트                           |
| `app/templates/`                       | Jinja2 HTML (base, main, auth, studio, admin)                        |
| `app/static/`                          | CSS, JS (업로드·스튜디오·인증 등)                                    |
| `uploads/videos`, `uploads/thumbnails` | 업로드 파일 저장 (config 기준)                                       |
| `instance/wetube.db`                   | SQLite DB 파일                                                       |

---

## 2. 코드 주석·구조 요약 (주요 파일)

### 2.1 `app/__init__.py`

- **역할**: Flask 앱 팩토리 – 업로드·DB 설정 포함.
- **주요 주석·동작**
  - `db = SQLAlchemy()`: DB 확장 객체 (나중에 `db.init_app(app)` 로 앱에 연결).
  - `create_app()`: 프로젝트 루트 기준으로 `uploads/videos`, `uploads/thumbnails`, `instance` 경로 계산 후 `app.config.from_mapping(...)` 에 넣음.
  - `SECRET_KEY`, `SQLALCHEMY_DATABASE_URI`, `VIDEO_FOLDER`, `THUMBNAIL_FOLDER`, `MAX_*_SIZE`, `ALLOWED_*_EXTENSIONS`, `DEFAULT_USER_ID` 등 한곳에서 설정.
  - `os.makedirs(..., exist_ok=True)`: 업로드·instance 폴더 없으면 생성.
  - `db.init_app(app)` 후 Blueprint 등록 (`main_bp`, `auth_bp`, `studio_bp`, `admin_bp`).
  - `with app.app_context(): db.create_all()`: 모델 기준 테이블 생성.
  - `User.query.get(1)` 이 없으면 `username=default` 인 기본 유저 생성 (업로드 시 `user_id=1` 사용).
- **모듈 레벨 `app = create_app()`**: `flask run` / `FLASK_APP=app` 로 로드할 때와 동일한 앱 인스턴스 사용.

### 2.2 `app/routes/studio.py`

- **역할**: Studio 라우트 – 동영상 목록·업로드·편집 페이지 및 업로드 처리.
- **헬퍼**
  - `_allowed_file(filename, allowed_extensions)`: 확장자(소문자)가 허용 목록에 있는지 검사, 빈 filename·`.` 없음 처리.
  - `_save_upload_file(file_storage, save_dir, allowed_extensions, max_size)`: 업로드 검증 후 UUID 기반 파일명으로 저장. 반환 `(저장된_파일명, None)` 또는 `(None, 에러메시지)`.
- **라우트**
  - `GET /studio`, `GET /studio/`: `render_template("studio/index.html")`.
  - `GET/POST /studio/upload`: GET은 폼, POST는 제목·비디오 필수 검증 → 비디오 저장 → 썸네일(선택) 저장 → 실패 시 비디오 삭제 → `Video` 생성 시 `user_id=current_app.config.get("DEFAULT_USER_ID", 1)`.
  - `GET /studio/edit/<int:video_id>`: 편집 페이지 렌더.
- **에러 처리**: 제목/파일/썸네일/DB 실패 시 `flash(..., "error")` 후 같은 폼 재렌더 또는 400/500, DB 실패 시 이미 저장한 파일 삭제 후 롤백.

### 2.3 `app/models/video.py`, `user.py`

- **Video**: `videos` 테이블. `title`, `description`, `video_path`, `thumbnail_path`, `user_id`(FK → users.id, CASCADE), `created_at`, `updated_at` 등. DB에는 파일명만 저장, 실제 파일은 config 폴더에.
- **User**: `users` 테이블. `id`, `username`, `email`, `password_hash` 등. Video의 `user_id` FK 대상.

### 2.4 `app/__main__.py`

- **역할**: `python -m app` 실행 시 진입점. `from app import app` 후 `app.run(debug=True, host="127.0.0.1", port=5000)`.

---

## 3. 개념·어원·동작 원리

### 3.1 Flask

- **개념**: Python용 경량 WSGI 웹 프레임워크. URL과 함수를 매핑하고, 요청/응답·템플릿·세션 등을 다룬다.
- **어원**: “플라스크(병)” – 작고 필요한 것만 담는다는 의미.
- **동작 원리**: WSGI 규약에 따라 서버가 호출하는 `app(environ, start_response)` 호출 가능한 객체를 제공. 내부에서 URL 라우팅, 요청 컨텍스트, 템플릿 렌더링, 확장(DB, 폼 등)을 조합한다.

### 3.2 Blueprint

- **개념**: 라우트·뷰·정적 파일 등을 하나의 단위로 묶는 Flask의 “하위 애플리케이션” 단위. URL 접두사(`url_prefix`)로 구분(예: `/studio`).
- **어원**: Blueprint = 설계도. 앱을 기능 단위로 나누는 설계도.
- **동작 원리**: `Blueprint("studio", __name__, url_prefix="/studio")` 로 생성 후 `@studio_bp.route("/upload")` 처럼 라우트 등록. 앱에서 `app.register_blueprint(studio_bp)` 하면 `/studio/upload` 등이 앱에 붙는다.

### 3.3 SQLAlchemy / Flask-SQLAlchemy

- **개념**: SQLAlchemy는 Python ORM(객체–관계 매핑). DB 테이블을 클래스로 정의하고, 객체 단위로 조회·추가·수정·삭제. Flask-SQLAlchemy는 Flask 앱에 연동한 확장으로 `db.Model`, `db.session` 등을 제공.
- **어원**: Alchemy = 연금술. 데이터를 “변환·조합”한다는 이미지.
- **동작 원리**: `db = SQLAlchemy()` 로 확장 생성 → `db.init_app(app)` 로 앱과 연결. 모델은 `db.Model` 상속, `db.Column`, `db.ForeignKey` 등으로 컬럼 정의. `db.create_all()` 은 등록된 모델로 테이블 생성. `db.session.add()`, `db.session.commit()`, `db.session.rollback()` 로 트랜잭션 처리.

### 3.4 Jinja2

- **개념**: Python 템플릿 엔진. HTML 안에 `{{ 변수 }}`, `{% block %}`, `{% for %}` 등으로 동적 내용을 넣는다.
- **어원**: Jinja = 일본 신사. “템플릿의 신” 같은 네이밍.
- **동작 원리**: `render_template("studio/upload.html", title=title)` 호출 시 Flask가 Jinja2로 해당 파일을 렌더링하고, 인자로 넘긴 변수를 템플릿에서 사용할 수 있게 한다. `extends`, `block`으로 레이아웃 상속(예: base.html).

### 3.5 flash / get_flashed_messages

- **개념**: 한 번만 보여줄 메시지(성공/에러 등)를 세션에 넣었다가 다음 요청에서 꺼내 쓰는 메커니즘.
- **동작 원리**: `flash("제목을 입력해주세요.", "error")` 하면 메시지가 세션에 리스트로 추가. 템플릿에서 `get_flashed_messages(with_categories=true)` 로 꺼내서 표시하면, 한 번 읽은 뒤 제거되어 재요청 시에는 안 보인다.

### 3.6 url_for

- **개념**: 라우트 이름(Blueprint이름.함수이름)과 인자로 해당 URL 문자열을 만드는 함수.
- **동작 원리**: `url_for("studio.upload")` → `/studio/upload`, `url_for("studio.edit", video_id=1)` → `/studio/edit/1`. 라우트 URL을 코드/템플릿에서 하드코딩하지 않도록 한다.

### 3.7 request.form / request.files

- **개념**: HTTP 요청 본문의 폼 데이터(form)와 파일(multipart) 데이터.
- **동작 원리**: POST 폼이면 `request.form.get("title")`, 파일은 `request.files.get("video")`. Flask가 multipart/form-data 를 파싱해 이 객체들에 넣어 준다.

### 3.8 current_app

- **개념**: 현재 요청이 처리되는 Flask 앱 인스턴스에 접근하는 프록시. 라우트/뷰 안에서 전역 변수 없이 config 등을 쓸 때 사용.
- **동작 원리**: 요청 컨텍스트 안에서만 유효. `current_app.config["VIDEO_FOLDER"]` 처럼 설정값 접근.

### 3.9 WSGI (Web Server Gateway Interface)

- **개념**: Python 웹 앱과 웹 서버 사이의 표준 인터페이스. 서버가 `app(environ, start_response)` 형태로 호출하고, 앱이 응답을 반환한다.
- **동작 원리**: `flask run` 은 내부적으로 WSGI 서버(예: Werkzeug)를 띄우고, 우리가 만든 `app` 객체를 그 서버에 넘겨서 요청을 처리한다.

### 3.10 Python 3.13과 SQLAlchemy

- **개념**: Python 3.13에서 typing 쪽에 `__static_attributes__` 등이 추가되면서, SQLAlchemy 구버전(예: 2.0.23)의 `TypingOnly` 검사와 충돌해 AssertionError 가 난다.
- **대응**: SQLAlchemy를 2.0.36 이상으로 올리면 해결. `requirements.txt` 에 `SQLAlchemy>=2.0.36` 명시.

---

## 4. 기본 문법·사용법

### 4.1 Flask 앱 생성·실행

```python
# 앱 팩토리 패턴
def create_app():
    app = Flask(__name__)
    app.config.from_mapping(SECRET_KEY="...", ...)
    # 확장 초기화, Blueprint 등록
    return app

app = create_app()
```

- **실행**: 터미널에서 `set FLASK_APP=app` (Windows) 또는 `export FLASK_APP=app` (Linux/Mac) 후 `flask run`. 또는 `python -m app` (`__main__.py` 에서 `app.run()` 호출).

### 4.2 Blueprint 라우트 정의

```python
from flask import Blueprint, render_template

studio_bp = Blueprint("studio", __name__, url_prefix="/studio")

@studio_bp.route("/")
def index():
    return render_template("studio/index.html")

@studio_bp.route("/upload", methods=["GET", "POST"])
def upload():
    if request.method == "GET":
        return render_template("studio/upload.html")
    # POST 처리 ...
```

- **등록**: `app.register_blueprint(studio_bp)`.

### 4.3 Flask-SQLAlchemy 모델·세션

```python
from app import db

class Video(db.Model):
    __tablename__ = "videos"
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    title = db.Column(db.String(200), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey("users.id", ondelete="CASCADE"), nullable=False)

# 사용
video = Video(title="제목", video_path="파일명.mp4", user_id=1)
db.session.add(video)
db.session.commit()
# 실패 시
db.session.rollback()
```

### 4.4 템플릿에서 변수·url_for

```html
<title>{% block title %}Studio - WeTube{% endblock %}</title>
<p>{{ title or '' }}</p>
<a href="{{ url_for('studio.upload') }}">업로드</a>
<a href="{{ url_for('studio.edit', video_id=video.id) }}">편집</a>
{% for category, message in get_flashed_messages(with_categories=true) %}
<p class="auth-msg auth-msg--{{ category }}">{{ message }}</p>
{% endfor %}
```

### 4.5 설정값 읽기

```python
from flask import current_app

video_folder = current_app.config["VIDEO_FOLDER"]
user_id = current_app.config.get("DEFAULT_USER_ID", 1)
```

### 4.6 폼·파일 수신·리다이렉트·flash

```python
from flask import request, redirect, url_for, flash

title = (request.form.get("title") or "").strip()
video_file = request.files.get("video")
flash("동영상이 업로드되었습니다.", "success")
return redirect(url_for("studio.index"))
```

### 4.7 프로젝트에서 자주 쓰는 명령

| 목적                          | 명령                                                                       |
| ----------------------------- | -------------------------------------------------------------------------- |
| 가상환경 활성화 후 Flask 실행 | `cd ch05` → `venv\Scripts\activate` → `set FLASK_APP=app` → `flask run`    |
| 의존성 설치/업그레이드        | `pip install -r requirements.txt --upgrade`                                |
| 앱 모듈로 직접 실행           | `python -m app`                                                            |
| DB/업로드 폴더                | `instance/wetube.db`, `uploads/videos`, `uploads/thumbnails` (config 기준) |

---

## 5. 문서 목차와의 대응

| 문서                     | 이 문서(09)에서 다루는 내용                    |
| ------------------------ | ---------------------------------------------- |
| 01\_개요                 | §1 작업 내용·기능 요약, §1.2 디렉터리 역할     |
| 02\_설정\_Config         | §2.1 **init**.py 주석·config, §4.5 설정값 읽기 |
| 03\_모델\_Models         | §2.3 모델, §3.3 SQLAlchemy, §4.3 모델·세션     |
| 04*업로드*라우트         | §2.2 studio.py, §4.2·4.6 라우트·폼·flash       |
| 05*템플릿*및\_JS         | §4.4 템플릿 문법, §3.4 Jinja2                  |
| 06*사용*및\_테스트       | §4.7 실행 명령, §3.10 Python 3.13              |
| 07*작업*체크리스트       | §1 기능 요약과 연계                            |
| 08*프롬프트*명령어\_기록 | 별도 유지, 이 문서는 기술 참조                 |

이 문서는 위 항목들을 “개념·어원·동작 원리·문법·사용법” 관점에서 한곳에 모은 종합 참조용이다.
