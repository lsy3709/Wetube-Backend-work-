# 04. 업로드 라우트

## 라우트

- **URL**: `/studio/upload`
- **메서드**: GET(폼 표시), POST(업로드 처리)
- **파일**: `app/routes/studio.py`

## GET `/studio/upload`

- `render_template("studio/upload.html")`만 수행.
- 폼에 제출할 action은 `url_for("studio.upload")`로 POST 전송.

## POST `/studio/upload`

### 1. 폼 데이터 수신

- `title`: 제목 (필수)
- `description`: 설명 (선택)
- `video`: 비디오 파일 (필수, `request.files.get("video")`)
- `thumbnail`: 썸네일 파일 (선택, `request.files.get("thumbnail")`)

### 2. 검증 순서 및 에러 시 동작

1. **제목**

   - 비어 있음 → `flash("제목을 입력해주세요.", "error")` → 폼 다시 렌더 (400)
   - 200자 초과 → `flash("제목은 200자 이하여야 합니다.", "error")` → 폼 다시 렌더 (400)

2. **비디오 파일**

   - `_save_upload_file(video_file, VIDEO_FOLDER, ALLOWED_VIDEO_EXTENSIONS, MAX_VIDEO_SIZE)` 호출.
   - 파일 없음/확장자 불일치/용량 초과 시 → 에러 메시지 flash → 폼 다시 렌더 (400).

3. **썸네일(선택)**

   - 파일이 있는 경우에만 `_save_upload_file(thumbnail_file, THUMBNAIL_FOLDER, ...)` 호출.
   - 실패 시 이미 저장된 비디오 파일 삭제 후 에러 flash → 폼 다시 렌더 (400).

4. **DB 저장 실패**
   - 저장된 비디오(및 썸네일) 파일 삭제 후 `flash(..., "error")` → 폼 다시 렌더 (500).

에러 시에는 `render_template("studio/upload.html", title=title, description=description)`로 제목·설명을 다시 넣어서 표시한다.

### 3. 헬퍼 함수

- **`_allowed_file(filename, allowed_extensions)`**

  - `filename`이 비어 있거나 확장자가 없으면 False.
  - 확장자(소문자)가 `allowed_extensions`에 있으면 True.

- **`_save_upload_file(file_storage, save_dir, allowed_extensions, max_size)`**
  - 반환: `(저장된_파일명, None)` 또는 `(None, 에러메시지)`.
  - 검증: 파일 존재, 확장자 허용, 크기 ≤ max_size.
  - 저장 파일명: `uuid.uuid4().hex + "." + ext` (덮어쓰기·경로 조작 방지).

### 4. 성공 시

- `Video` 레코드 생성 (title, description, video_path, thumbnail_path, user_id=config.DEFAULT_USER_ID).
- `db.session.add(video)`, `db.session.commit()`.
- `flash("동영상이 업로드되었습니다.", "success")`.
- `redirect(url_for("studio.index"))`.

## 에러 메시지 예시

| 상황                      | 메시지                                                                            |
| ------------------------- | --------------------------------------------------------------------------------- |
| 제목 없음                 | 제목을 입력해주세요.                                                              |
| 제목 200자 초과           | 제목은 200자 이하여야 합니다.                                                     |
| 비디오 미선택/형식 불일치 | 파일이 선택되지 않았습니다. / 허용되지 않는 파일 형식입니다. 허용: mp4, mov, webm |
| 비디오 용량 초과          | 파일 크기가 너무 큽니다. 최대 NMB까지 업로드할 수 있습니다.                       |
| 썸네일 형식/용량 오류     | 동일한 형식의 메시지 (썸네일용 허용 목록·용량 기준)                               |
| DB 오류                   | DB 저장 중 오류가 발생했습니다: {예외 메시지}                                     |
