# 7.3.6 데이터베이스 확인: 회원정보 수정·비밀번호 변경

회원정보 수정 및 비밀번호 변경 기능을 데이터베이스로 확인하는 방법과 진행 순서를 안내합니다.

---

## 0. lsy 유저 정보 및 변경 전·후

| 구분 | 변경 전 | 변경 후 |
|------|---------|---------|
| **사용자명** | lsy | lsy (변경 불가) |
| **이메일** | lsy@example.com | lsy수정@example.com |
| **닉네임** | (빈 값) | lsy수정 |
| **비밀번호** | 1234 | 1234수정 |

> lsy 유저가 없으면 `/auth/register`에서 사용자명 `lsy`, 이메일 `lsy@example.com`, 비밀번호 `1234`로 회원가입 후 진행합니다.

---

## 1. 확인 대상 (`users` 테이블)

| 컬럼 | 회원정보 수정 시 변화 | 비밀번호 변경 시 변화 |
|------|------------------------|------------------------|
| `nickname` | 변경됨 | 없음 |
| `email` | 변경됨 | 없음 |
| `password_hash` | 없음 | 변경됨 (해시 전체 교체) |
| `updated_at` | 변경됨 | 변경됨 |

---

## 2. 확인 방법 요약

| 방법 | 명령/도구 | 용도 |
|------|-----------|------|
| **sqlite3 CLI** | `sqlite3 instance/wetube.db "SELECT ..."` | 빠른 조회, 스크립트 연동 |
| **Flask Shell** | `flask shell` 후 ORM 조회 | `check_password()`로 비밀번호 검증 |
| **DB Browser** | GUI로 `instance/wetube.db` 열기 | 시각적 확인 |

---

## 3. 진행 순서

### 3-1. 사전 준비

```powershell
cd C:\Wetube\ch05
.\venv\Scripts\Activate.ps1   # 선택
flask run
```

브라우저에서 `http://127.0.0.1:5000` 접속 후 로그인.

---

### 3-2. 순서 1: 수정 전 `users` 테이블 확인

로그인한 계정(예: `lsy`)의 **수정 전** 데이터를 확인합니다.

**sqlite3 CLI:**

```powershell
sqlite3 -header -column instance/wetube.db "SELECT id, username, email, nickname, substr(password_hash, 1, 20) AS pwd_preview, updated_at FROM users WHERE username='lsy';"
```

**예시 출력:**

| id | username | email | nickname | pwd_preview | updated_at |
|----|----------|-------|----------|-------------|-------------|
| 2 | lsy | lsy@example.com | (NULL) | scrypt:32768:8:1$... | 2025-02-04 12:00:00 |

수정 전 `email`, `nickname`, `password_hash` 앞부분, `updated_at`을 기록해 둡니다.

---

### 3-3. 순서 2: 회원정보 수정 수행 (닉네임·이메일)

1. 브라우저에서 `http://127.0.0.1:5000/auth/profile` 접속
2. 다음 값 입력:
   - **닉네임**: `lsy수정`
   - **이메일**: `lsy수정@example.com` (기존과 다른 이메일)
3. 비밀번호 관련 필드는 비워둠
4. **저장** 클릭

---

### 3-4. 순서 3: 회원정보 수정 후 DB 확인

```sql
SELECT id, username, email, nickname, updated_at FROM users WHERE username='lsy';
```

**기대 결과:**

| id | username | email | nickname | updated_at |
|----|----------|-------|----------|------------|
| 2 | lsy | lsy수정@example.com | lsy수정 | (현재 시각) |

- `email`, `nickname`이 변경되었는지 확인
- `updated_at`이 수정 시각으로 갱신되었는지 확인

---

### 3-5. 순서 4: 비밀번호 변경 수행

1. `http://127.0.0.1:5000/auth/profile` 접속
2. **보안** 섹션 입력:
   - **현재 비밀번호**: `1234` (기존 비밀번호)
   - **새 비밀번호**: `1234수정`
   - **새 비밀번호 확인**: `1234수정`
3. **저장** 클릭

---

### 3-6. 순서 5: 비밀번호 변경 후 DB 확인

**1) password_hash 변경 여부 (sqlite3)**

```sql
SELECT id, username, substr(password_hash, 1, 30) AS pwd_preview, updated_at FROM users WHERE username='lsy';
```

**기대 결과:**
- `password_hash` 값이 이전과 다름 (해시 전체가 교체됨)
- `updated_at` 갱신됨

**2) 비밀번호 검증 (Flask Shell)**

```powershell
flask shell
```

```python
>>> from app.models import User
>>> u = User.query.filter_by(username='lsy').first()
>>> u.check_password('1234수정')
# True
>>> u.check_password('1234')
# False
```

새 비밀번호만 통과하는지 확인합니다.

---

### 3-7. 순서 6: 이메일 중복 검사 확인 (선택)

다른 사용자가 이미 사용 중인 이메일로 변경 시도를 합니다.

1. 다른 계정(예: `default`)으로 로그인한 상태에서 `/auth/profile` 접속
2. **이메일**을 `lsy수정@example.com`(lsy가 사용 중인 이메일)로 입력
3. **저장** 클릭

**기대 결과:** "이미 사용 중인 이메일입니다" 에러 메시지, DB 변경 없음.

```sql
-- default 사용자의 email은 여전히 default@example.com
SELECT username, email FROM users WHERE username='default';
```

---

## 4. SQL 쿼리 요약

| 목적 | 쿼리 |
|------|------|
| 특정 사용자 프로필 조회 | `SELECT id, username, email, nickname, updated_at FROM users WHERE username='lsy';` |
| 비밀번호 해시 앞부분 확인 | `SELECT username, substr(password_hash, 1, 30) FROM users WHERE username='lsy';` |
| updated_at 갱신 확인 | `SELECT username, updated_at FROM users WHERE username='lsy';` |

---

## 5. 진행 순서 한눈에 보기

```
1. 앱 실행, lsy/1234 로 로그인
       ↓
2. 수정 전 users 데이터 확인 (sqlite3)
       ↓
3. /auth/profile 에서 닉네임·이메일 → lsy수정, lsy수정@example.com → 저장
       ↓
4. DB에서 email, nickname, updated_at 변경 확인
       ↓
5. /auth/profile 에서 비밀번호 1234 → 1234수정 변경 → 저장
       ↓
6. DB에서 password_hash 변경 확인
       ↓
7. Flask Shell에서 check_password('1234수정') → True 확인
       ↓
8. (선택) 이메일 중복 시도 → 에러, DB 미변경 확인
```

---

## 6. 정리

| 확인 대상 | 확인 방법 |
|-----------|-----------|
| **닉네임·이메일 수정** | `SELECT email, nickname, updated_at FROM users WHERE username='...'` |
| **비밀번호 변경** | `password_hash` 값 변화 + Flask Shell `check_password()` |
| **이메일 중복 방지** | 다른 사용자 이메일로 변경 시도 → 에러 메시지 |
| **단위 테스트** | `python -m pytest tests/test_auth_profile.py -v` |
